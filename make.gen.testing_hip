# File: make.gen.testing_hip
#   @author Cade Brown <cbrow216@vols.utk.edu>
#
# Generates the `testing_hip` folder automatically from the `testing` directory automatically
#
# Run like:
# $ make -f make.gen.testing_hip
#
# To clean/remove all changes:
# $ make -f make.gen.testing_hip clean
#
#
# To set the `HIPIFY` script, run:
# $ export HIPIFY=/path/to/hipify-perl
# (or the equivalent for your shell)
#
# -*-
#
# Notes: Never touches or changes anything other than testing_hip/
#
# This is not a full solution yet; some of our code needs to probably be changed in MAGMA
#   For instance, adding HIP-specific things and a more configurable build process (so it can be built without cublas)
#

# utility functions
HIPIFY            ?= tools/hipify-perl

# TODO: Distribute a `hipify` script with MAGMA

ifeq ($(HIPIFY),)
$(error Could not find `hipify` please run like `HIPIFY=... make testing_hip`)
endif

#*- input files -*#


#*- input sources -*#

testing_src_cpp := $(wildcard testing/*.cpp)
testing_src_h   := $(wildcard testing/*.h)
testing_src_mk  := $(wildcard testing/Makefile*)
testing_src_f90 := $(wildcard testing/*.F90 testing/*.f90)

#*- generated output -*#

testing_hip_src_cpp  := $(subst testing/,testing_hip/,$(testing_src_cpp))
testing_hip_src_h    := $(subst testing/,testing_hip/,$(testing_src_h))
testing_hip_src_mk   := $(subst testing/,testing_hip/,$(testing_src_mk))


#*- build rules -*#

# a 'fake' target to build and force the creation of the output directory
_FAKE_TARGET = testing_hip/.cache

# by default just build everything
all: $(_FAKE_TARGET)

# special rule to build fake target instead
.PHONY: all clean $(_FAKE_TARGET)

# have the cache set on all generated outputs
$(_FAKE_TARGET): testing_hip $(testing_hip_src_cpp) $(testing_hip_src_h) $(testing_hip_src_mk)

# just creates the directory
testing_hip:
	mkdir -p $@
	cp $(testing_src_f90) $@

# removes the directory (which is the only place this makefile will generate to 
clean:
	rm -rf testing_hip

# basic cpp translation
testing_hip/%.cpp: testing/%.cpp
	$(HIPIFY) $< > $@

testing_hip/%.h: testing/%.h
	$(HIPIFY) $< > $@

# little hack so % acts like Makefile*.
testing_hip/Makefil%: testing/Makefil%
	cp $< $@
	@sed -i -e "s/:=  *testing/:= testing_hip/g" $@
	@sed -i -e "s/.cuh/.hip.hpp/g" $@
	@sed -i -e "s/.cu/.hip.cpp/g" $@



